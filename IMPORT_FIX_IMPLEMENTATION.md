# Import State Preservation Fix - Implementation Summary

## Problem Identified

When importing NetBox resources, optional fields that exist in NetBox were not being populated in Terraform state. This was caused by the `mapResponseToModel` functions checking if fields were null and preserving that null value:

```go
// BROKEN PATTERN
if tenant, ok := aggregate.GetTenantOk(); ok && tenant != nil && tenant.Id != 0 {
    data.Tenant = utils.UpdateReferenceAttribute(data.Tenant, tenant.GetName(), tenant.GetSlug(), tenant.GetId())
} else if data.Tenant.IsNull() {
    // Keep null if it was null ← PROBLEM: During import, everything starts null!
} else {
    data.Tenant = types.StringNull()
}
```

During import, state starts completely empty (all fields null), so the logic would keep fields null even when the API returned values.

## Solution Implemented

### 1. Simplified Mapping Logic

Removed the problematic `else if data.Field.IsNull()` blocks from `mapResponseToModel`:

```go
// FIXED PATTERN
if tenant, ok := aggregate.GetTenantOk(); ok && tenant != nil && tenant.Id != 0 {
    data.Tenant = utils.UpdateReferenceAttributeFixed(data.Tenant, tenant.GetName(), tenant.GetSlug(), tenant.GetId())
} else {
    data.Tenant = types.StringNull()
}
```

Now the mapping **always** reflects what the API returns, regardless of current state.

### 2. Created Fixed Helper Functions

Created `internal/utils/state_helpers_fixed.go` with corrected helper functions:

- `UpdateReferenceAttributeFixed` - Always populates from API, doesn't check if current is null
- `StringFromAPIFixed` - Always sets value or null from API
- `NullableStringFromAPIFixed` - Same for nullable fields
- `Int64FromAPIFixed`, `BoolFromAPIFixed`, etc.

These helpers:
- ✅ Always populate from API response
- ✅ Preserve user's input format when it matches (name vs slug vs ID)
- ✅ Don't check if current is null before populating

### 3. Test Enhancements

Added comprehensive import tests that verify:
1. **Import with custom fields and tags** - Verifies import works with complex field types
2. **Import preserves optional fields** - Verifies import populates all fields from API

The key insight: When importing, the config SHOULD match what you're importing. If you import to a minimal config, Terraform will correctly want to set optional fields to null (that's not a bug, that's Terraform's design).

## Important Clarification on Terraform Behavior

### What We Fixed

✅ Import now populates ALL fields from NetBox API into state
✅ Fields are no longer lost during import
✅ State accurately reflects what exists in NetBox

### Terraform's Expected Behavior (NOT a bug)

When you have optional fields:
- Config specifies field → State must match config value
- Config doesn't specify field → State should be null (Terraform will "fix" this)

This is by design. If you want Terraform to manage a resource with optional fields:
1. **Import to a config that includes those fields**
2. Or accept that Terraform will set unspecified optional fields to null

### When to Use `Computed: true`

`Computed: true` should ONLY be used for fields that:
- Are calculated/generated by the provider
- Can be set by the API even when not in config
- Users don't directly configure

Examples: `id`, `last_updated`, auto-generated names, etc.

**Don't use** `Computed: true` for:
- Optional fields users can set
- Fields that should match config when specified

## Files Changed

### Updated
1. `internal/resources/aggregate_resource.go`
   - Simplified `mapResponseToModel` to always populate from API
   - Removed `else if data.Field.IsNull()` blocks
   - Updated to use `UpdateReferenceAttributeFixed` for tenant field

2. `internal/resources_acceptance_tests/aggregate_resource_test.go`
   - Enhanced import test with PlanOnly step
   - Added `TestAccAggregateResource_importPreservesOptionalFields`
   - Tests import with full config (realistic scenario)

### Created
1. `internal/utils/state_helpers_fixed.go`
   - New helper functions that always populate from API
   - Ready to replace original helpers once proven across all resources

2. `IMPORT_STATE_PRESERVATION_FIX.md`
   - Comprehensive documentation of the issue and solution

3. `internal/examples/import_fix_pattern.go`
   - Before/after code examples

## Test Results

All aggregate resource tests pass:
- ✅ TestAccAggregateResource_basic
- ✅ TestAccAggregateResource_update
- ✅ TestAccAggregateResource_full
- ✅ TestAccAggregateResource_IDPreservation
- ✅ TestAccAggregateResource_externalDeletion
- ✅ TestAccAggregateResource_importWithCustomFieldsAndTags
- ✅ TestAccAggregateResource_importPreservesOptionalFields
- ✅ Terraform integration test

## Next Steps

1. ✅ Verified fix works for aggregate resource
2. ⏭️ Apply same pattern to other resources experiencing import issues
3. ⏭️ Once proven stable, update original helper functions in `state_helpers.go`
4. ⏭️ Remove `state_helpers_fixed.go` and migrate all resources to fixed version
5. ⏭️ Add similar import preservation tests for other critical resources

## Key Takeaway

The fix ensures import accurately populates state from NetBox API. The helper functions no longer skip populating fields just because they're currently null. This makes import work correctly while maintaining proper state mapping for regular CRUD operations.
