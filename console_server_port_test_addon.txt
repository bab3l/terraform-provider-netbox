
func TestAccConsoleServerPortResource_externalDeletion(t *testing.T) {
	t.Parallel()
	testutil.TestAccPreCheck(t)
	siteName := testutil.RandomName("tf-test-site")
	siteSlug := testutil.RandomSlug("tf-test-site")
	mfgName := testutil.RandomName("tf-test-mfg")
	mfgSlug := testutil.RandomSlug("tf-test-mfg")
	dtModel := testutil.RandomName("tf-test-dt")
	dtSlug := testutil.RandomSlug("tf-test-dt")
	roleName := testutil.RandomName("tf-test-role")
	roleSlug := testutil.RandomSlug("tf-test-role")
	deviceName := testutil.RandomName("tf-test-device")
	portName := testutil.RandomName("tf-test-csp-ext-del")
	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testutil.TestAccPreCheck(t) },
		ProtoV6ProviderFactories: testutil.TestAccProtoV6ProviderFactories,
		Steps: []resource.TestStep{
			{
				Config: testAccConsoleServerPortResourceConfig(siteName, siteSlug, mfgName, mfgSlug, dtModel, dtSlug, roleName, roleSlug, deviceName, portName),
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("netbox_console_server_port.test", "name", portName),
					resource.TestCheckResourceAttrSet("netbox_console_server_port.test", "id"),
				),
			},
			{
				PreConfig: func() {
					client, err := testutil.GetSharedClient()
					if err != nil {
						t.Fatalf("Failed to get shared client: %v", err)
					}
					ports, _, err := client.DcimAPI.DcimConsoleServerPortsList(context.Background()).NameIc(portName).Execute()
					if err != nil || ports == nil || len(ports.Results) == 0 {
						t.Fatalf("Failed to find console server port for external deletion: %v", err)
					}
					portID := ports.Results[0].Id
					_, err = client.DcimAPI.DcimConsoleServerPortsDestroy(context.Background(), portID).Execute()
					if err != nil {
						t.Fatalf("Failed to externally delete console server port: %v", err)
					}
					t.Logf("Successfully externally deleted console server port with ID: %d", portID)
				},
				Config: testAccConsoleServerPortResourceConfig(siteName, siteSlug, mfgName, mfgSlug, dtModel, dtSlug, roleName, roleSlug, deviceName, portName),
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttrSet("netbox_console_server_port.test", "id"),
				),
			},
		},
	})
}
