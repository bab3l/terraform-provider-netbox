
func TestAccConsolePortResource_externalDeletion(t *testing.T) {
	t.Parallel()

	testutil.TestAccPreCheck(t)

	siteName := testutil.RandomName("tf-test-site")
	siteSlug := testutil.RandomSlug("tf-test-site")
	mfgName := testutil.RandomName("tf-test-mfg")
	mfgSlug := testutil.RandomSlug("tf-test-mfg")
	dtModel := testutil.RandomName("tf-test-dt")
	dtSlug := testutil.RandomSlug("tf-test-dt")
	roleName := testutil.RandomName("tf-test-role")
	roleSlug := testutil.RandomSlug("tf-test-role")
	deviceName := testutil.RandomName("tf-test-device")
	consolePortName := testutil.RandomName("tf-test-cp-ext-del")

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testutil.TestAccPreCheck(t) },
		ProtoV6ProviderFactories: testutil.TestAccProtoV6ProviderFactories,

		Steps: []resource.TestStep{
			{
				Config: testAccConsolePortResourceConfig(siteName, siteSlug, mfgName, mfgSlug, dtModel, dtSlug, roleName, roleSlug, deviceName, consolePortName),
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttr("netbox_console_port.test", "name", consolePortName),
					resource.TestCheckResourceAttrSet("netbox_console_port.test", "id"),
				),
			},
			{
				PreConfig: func() {
					client, err := testutil.GetSharedClient()
					if err != nil {
						t.Fatalf("Failed to get shared client: %v", err)
					}

					// Get the console port by name and delete it
					ports, _, err := client.DcimAPI.DcimConsolePortsList(context.Background()).NameIc(consolePortName).Execute()
					if err != nil || ports == nil || len(ports.Results) == 0 {
						t.Fatalf("Failed to find console port for external deletion: %v", err)
					}

					portID := ports.Results[0].Id
					_, err = client.DcimAPI.DcimConsolePortsDestroy(context.Background(), portID).Execute()
					if err != nil {
						t.Fatalf("Failed to externally delete console port: %v", err)
					}

					t.Logf("Successfully externally deleted console port with ID: %d", portID)
				},
				Config: testAccConsolePortResourceConfig(siteName, siteSlug, mfgName, mfgSlug, dtModel, dtSlug, roleName, roleSlug, deviceName, consolePortName),
				Check: resource.ComposeAggregateTestCheckFunc(
					resource.TestCheckResourceAttrSet("netbox_console_port.test", "id"),
				),
			},
		},
	})
}
